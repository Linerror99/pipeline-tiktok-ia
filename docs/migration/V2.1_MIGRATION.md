# üöÄ MIGRATION V2.1 - DOCUMENTATION

## Vue d'ensemble

Migration du syst√®me V1 (8 clips Imagen) vers V2 (Veo 3.1 parall√®le) avec nouveau frontend React TypeScript.

---

## ‚úÖ √âtapes Compl√©t√©es

### Frontend
- ‚úÖ Copi√© `front-v2-reetik app` ‚Üí `frontend-v2/`
- ‚úÖ Cr√©√© `src/services/api.ts` - Service API complet
- ‚úÖ Cr√©√© `src/hooks/useVideoProgress.ts` - WebSocket + polling fallback
- ‚è≥ √Ä adapter: Pages CreateVideo, GenerationProgress, Library

### Backend (√Ä faire)
- ‚è≥ Modifier `video_generation.py` - Appel agent-script-v2
- ‚è≥ Modifier `storage.py` - Firestore V2 + nouveau bucket
- ‚è≥ Cr√©er `websocket.py` - Temps r√©el avec socket.io
- ‚è≥ Mettre √† jour `videos.py` - Param√®tres dur√©e/style

---

## üìã TODO Backend

### 1. video_generation.py
```python
# Changements:
- SCRIPT_AGENT_URL = agent-script-v2 URL
- Ajouter target_duration dans payload
- R√©cup√©rer video_id depuis r√©ponse (pas g√©n√©r√© localement)
```

### 2. storage.py
```python
# Changements:
- Utiliser BUCKET_NAME_V2 au lieu de BUCKET_NAME
- Lire depuis Firestore v2_veo_operations au lieu de blobs GCS
- Nouveau format: {video_id}/final.mp4
- Mapper status Firestore ‚Üí API:
  - script_generated ‚Üí "G√©n√©ration script termin√©e"
  - generating_parallel ‚Üí "G√©n√©ration vid√©os (X/Y blocs)"
  - ready_for_assembly ‚Üí "Pr√©paration assemblage"
  - completed ‚Üí "Termin√©"
  - failed ‚Üí "Erreur"
```

### 3. websocket.py (NOUVEAU)
```python
from fastapi import WebSocket
from google.cloud import firestore

# Firestore watcher sur v2_video_status/{video_id}
# Broadcaster changements via WebSocket
```

### 4. videos.py
```python
# Ajouter dans VideoCreateRequest:
- target_duration: int = 36
- style: str = "informative"  
- language: str = "fr"
```

---

## üîó URLs Cloud Functions

```bash
AGENT_SCRIPT_V2=https://agent-script-v2-vrzs3y5aoq-uc.a.run.app
AGENT_VIDEO_V2=https://agent-video-v2-vrzs3y5aoq-uc.a.run.app
CHECK_AND_RETRY=https://check-and-retry-clips-vrzs3y5aoq-uc.a.run.app
AGENT_ASSEMBLER_V2=https://agent-assembler-v2-vrzs3y5aoq-uc.a.run.app
```

---

## üìä Mapping Firestore ‚Üí Frontend

### Collection: v2_video_status
```json
{
  "video_id": "test_20260201_203648",
  "status": "generating_parallel",
  "current_step": "G√©n√©ration bloc 3/9",
  "total_blocks": 9,
  "completed_blocks": 2,
  "created_at": "2026-02-01T20:36:48Z",
  "updated_at": "2026-02-01T20:38:15Z"
}
```

### Collection: v2_veo_operations
```json
{
  "video_id": "test_20260201_203648",
  "status": "ready_for_assembly",
  "total_blocks": 9,
  "completed_blocks": 9,
  "final_url": "gs://bucket/test_20260201_203648/final.mp4",
  "blocks": [...],
  "operations": {...},
  "clips_status": {...}
}
```

---

## üé® Messages d'Erreur Utilisateur

```typescript
const ERROR_MESSAGES = {
  'usage guidelines': 'Le contenu demand√© ne respecte pas les r√®gles de s√©curit√© de Google. Essayez un th√®me diff√©rent.',
  'third-party content': 'Impossible de g√©n√©rer du contenu prot√©g√© par copyright. √âvitez les personnages/marques connus.',
  'quota exceeded': 'Quota API d√©pass√©. R√©essayez dans quelques minutes.',
  'operation timeout': 'La g√©n√©ration a pris trop de temps. R√©essayez avec une dur√©e plus courte.',
  'assembly failed': 'Erreur lors de l\'assemblage de la vid√©o. Contactez le support.',
  'default': 'Une erreur est survenue. Veuillez r√©essayer.'
};
```

---

## üöÄ D√©ploiement Cloud Run

### Backend
```bash
cd backend
gcloud builds submit --tag gcr.io/reetik-project/backend-v2
gcloud run deploy backend-v2 \
  --image gcr.io/reetik-project/backend-v2 \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars GCP_PROJECT=reetik-project,BUCKET_NAME_V2=tiktok-pipeline-v2-artifacts-reetik-project
```

### Frontend
```bash
cd frontend-v2
npm run build
gcloud builds submit --tag gcr.io/reetik-project/frontend-v2
gcloud run deploy frontend-v2 \
  --image gcr.io/reetik-project/frontend-v2 \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated
```

---

## üìù Prochaines √âtapes

1. ‚úÖ Frontend: Services API cr√©√©s
2. ‚è≥ Backend: Modifier les 4 fichiers list√©s
3. ‚è≥ Frontend: Adapter CreateVideoPage pour utiliser apiService
4. ‚è≥ Frontend: Adapter GenerationProgressPage avec useVideoProgress
5. ‚è≥ Frontend: Adapter LibraryPage pour lister vid√©os V2
6. ‚è≥ Tests end-to-end
7. ‚è≥ D√©ploiement Cloud Run

---

## üîê Variables d'Environnement

### Backend (.env)
```bash
GCP_PROJECT=reetik-project
BUCKET_NAME_V2=tiktok-pipeline-v2-artifacts-reetik-project
SCRIPT_AGENT_URL=https://agent-script-v2-vrzs3y5aoq-uc.a.run.app
JWT_SECRET_KEY=your-secret-key
CORS_ORIGINS=["https://frontend-v2-...run.app"]
```

### Frontend (.env)
```bash
VITE_API_URL=https://backend-v2-...run.app
```
